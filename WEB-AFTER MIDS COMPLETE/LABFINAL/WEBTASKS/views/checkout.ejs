<div class="pastel-page" style="display: flex; justify-content: center;">
    <!-- Breadcrumb -->
    <div style="width: 100%; max-width: 600px;">
        <div class="breadcrumb-nav">
            <a href="/" class="breadcrumb-item">Home</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/shop" class="breadcrumb-item">Shop</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/cart" class="breadcrumb-item">Cart</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">Checkout</span>
        </div>

        <% if (typeof error !== 'undefined' && error && error.length) { %>
            <div style="margin: 14px 0; padding: 12px 14px; border-left: 5px solid #ef4444; background: rgba(239,68,68,.08); color: #7f1d1d; border-radius: 10px;">
                <strong style="display:block; margin-bottom:4px;">Heads up</strong>
                <span><%= error[0] %></span>
            </div>
        <% } %>
        <% if (typeof success !== 'undefined' && success && success.length) { %>
            <div style="margin: 14px 0; padding: 12px 14px; border-left: 5px solid #22c55e; background: rgba(34,197,94,.08); color: #065f46; border-radius: 10px;">
                <strong style="display:block; margin-bottom:4px;">Success</strong>
                <span><%= success[0] %></span>
            </div>
        <% } %>

        <div class="pretty-form-container">
            <h2 style="text-align: center; font-style: italic;">Complete Your Purchase</h2>
            
            <form action="/checkout" method="POST" style="margin-top: 30px;" id="checkoutForm">
                <% const checkoutTotal = (cart || []).reduce((sum, item) => sum + (item.price * item.qty), 0); %>

                <h4 style="color: var(--grey-2); font-weight: 700; margin-top: 12px; margin-bottom: 12px; text-transform: uppercase; font-size: 13px; letter-spacing: 0.7px;">Order Summary</h4>
                <div style="background: #f8fafc; border: 1px solid #eef2f6; border-radius: 12px; padding: 12px 16px; margin-bottom: 18px;">
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <% (cart || []).forEach(item => { %>
                            <li style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #e5e7eb;">
                                <span><%= item.name %> (x<%= item.qty %>)</span>
                                <span>$<%= (item.price * item.qty).toFixed(2) %></span>
                            </li>
                        <% }) %>
                    </ul>
                    <div style="display: flex; justify-content: space-between; font-weight: 800; margin-top: 10px;">
                        <span>Total</span>
                        <span>$<%= checkoutTotal.toFixed(2) %></span>
                    </div>
                </div>
                <!-- Contact Information -->
                <h4 style="color: var(--grey-2); font-weight: 700; margin-top: 28px; margin-bottom: 16px; text-transform: uppercase; font-size: 13px; letter-spacing: 0.7px;">Contact Information</h4>
                
                <label class="pretty-label">Full Name *</label>
                <input type="text" class="pretty-input" name="name" required minlength="2" maxlength="100" placeholder="John Doe" pattern="[A-Za-z\s]+" title="Please enter a valid name (letters and spaces only)">

                <label class="pretty-label">Email Address *</label>
                <input type="email" class="pretty-input" name="email" required placeholder="john@example.com" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" title="Please enter a valid email address">

                <label class="pretty-label">Phone Number *</label>
                <input type="tel" class="pretty-input" name="phone" required placeholder="+1 (555) 123-4567" pattern="[0-9+\s\-\(\)]{10,20}" title="Please enter a valid phone number">

                <!-- Shipping Address -->
                <h4 style="color: var(--grey-2); font-weight: 700; margin-top: 28px; margin-bottom: 16px; text-transform: uppercase; font-size: 13px; letter-spacing: 0.7px;">Shipping Address</h4>
                
                <label class="pretty-label">Street Address *</label>
                <textarea class="pretty-textarea" name="address" required minlength="5" placeholder="123 Main Street, Apt 4B" style="resize: vertical; min-height: 80px;"></textarea>

                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label class="pretty-label">City *</label>
                        <input type="text" class="pretty-input" name="city" required minlength="2" placeholder="New York">
                    </div>
                    <div style="flex: 1;">
                        <label class="pretty-label">State/Province *</label>
                        <input type="text" class="pretty-input" name="state" required minlength="2" placeholder="NY">
                    </div>
                </div>

                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label class="pretty-label">Zip/Postal Code *</label>
                        <input type="text" class="pretty-input" name="zip" required pattern="[0-9A-Za-z\s\-]{3,10}" placeholder="10001" title="Please enter a valid postal code">
                    </div>
                    <div style="flex: 1;">
                        <label class="pretty-label">Country *</label>
                        <input type="text" class="pretty-input" name="country" required minlength="2" placeholder="United States" value="United States">
                    </div>
                </div>

                <!-- Payment Information -->
                <h4 style="color: var(--grey-2); font-weight: 700; margin-top: 28px; margin-bottom: 16px; text-transform: uppercase; font-size: 13px; letter-spacing: 0.7px;">Payment Information</h4>
                
                <label class="pretty-label">Card Number *</label>
                <input type="text" class="pretty-input" name="cardNumber" required placeholder="1234 5678 9012 3456" maxlength="19" id="cardNumber" pattern="[0-9\s]{13,19}" title="Please enter a valid card number">

                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label class="pretty-label">Expiry Date (MM/YY) *</label>
                        <input type="text" class="pretty-input" name="cardExpiry" required placeholder="12/25" maxlength="5" id="cardExpiry" pattern="(0[1-9]|1[0-2])\/([0-9]{2})" title="Format: MM/YY">
                    </div>
                    <div style="flex: 1;">
                        <label class="pretty-label">CVV *</label>
                        <input type="text" class="pretty-input" name="cardCvv" required placeholder="123" maxlength="4" pattern="[0-9]{3,4}" title="3 or 4 digit security code">
                    </div>
                </div>

                <label class="pretty-label">Cardholder Name *</label>
                <input type="text" class="pretty-input" name="cardholderName" required minlength="2" placeholder="John Doe" pattern="[A-Za-z\s]+" title="Name as it appears on card">

                <!-- Trust Badges -->
                <div class="trust-badges" style="margin: 32px 0;">
                    <div class="badge-item">
                        <span class="badge-icon">ðŸ”’</span>
                        <strong>SSL Secured</strong>
                    </div>
                    <div class="badge-item">
                        <span class="badge-icon">âœ“</span>
                        <strong>Safe Payment</strong>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn-action" style="width: 100%; margin-top: 30px; background: var(--grad-sky); color: white; font-size: 16px;">Complete Order</button>
            </form>

            <script>
            // Client-side validation and formatting
            (function() {
                const form = document.getElementById('checkoutForm');
                const cardNumber = document.getElementById('cardNumber');
                const cardExpiry = document.getElementById('cardExpiry');

                // Format card number with spaces
                if (cardNumber) {
                    cardNumber.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\s/g, '');
                        let formatted = value.match(/.{1,4}/g);
                        e.target.value = formatted ? formatted.join(' ') : value;
                    });
                }

                // Format expiry date
                if (cardExpiry) {
                    cardExpiry.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        if (value.length >= 2) {
                            value = value.slice(0, 2) + '/' + value.slice(2, 4);
                        }
                        e.target.value = value;
                    });
                }

                // Simple card validation (just check format, not Luhn for testing)
                function validateCard(cardNumber) {
                    const digits = cardNumber.replace(/\s/g, '');
                    // Accept 13-19 digit numbers (allows test cards)
                    return /^[0-9]{13,19}$/.test(digits);
                }

                // Validate expiry date
                function validateExpiry(expiry) {
                    const parts = expiry.split('/');
                    if (parts.length !== 2) return false;
                    const month = parseInt(parts[0]);
                    const year = parseInt('20' + parts[1]);
                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentMonth = now.getMonth() + 1;
                    
                    if (month < 1 || month > 12) return false;
                    if (year < currentYear) return false;
                    if (year === currentYear && month < currentMonth) return false;
                    return true;
                }

                if (form) {
                    form.addEventListener('submit', function(e) {
                        if (!cardNumber || !cardExpiry) return true; // Skip if elements not found
                        
                        const cardNum = cardNumber.value;
                        const expiry = cardExpiry.value;

                        if (!validateCard(cardNum)) {
                            e.preventDefault();
                            alert('Please enter a valid card number (13-19 digits).');
                            cardNumber.focus();
                            return false;
                        }

                        if (!validateExpiry(expiry)) {
                            e.preventDefault();
                            alert('Please enter a valid expiry date (must be in the future).');
                            cardExpiry.focus();
                            return false;
                        }
                    });
                }
            })();
            </script>
        </div>
    </div>
</div>